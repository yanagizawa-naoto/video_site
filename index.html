<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚«ãƒ¡ãƒ©éŒ²ç”»ãƒŸãƒ‹ã‚¢ãƒ—ãƒªï¼ˆPC & iPhoneå¯¾å¿œï¼‰</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --fg:#e5e7eb; --muted:#9ca3af; --accent:#38bdf8; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--fg); }
    .wrap { max-width: 960px; margin: 0 auto; padding: 20px; }
    header { display:flex; justify-content: space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    h1 { font-size: clamp(20px, 4.5vw, 28px); margin: 0; letter-spacing: .02em; }
    .hint { color: var(--muted); font-size: 13px; }
    .panel { background: var(--panel); border: 1px solid #1f2937; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1.2fr .8fr; } }

    video, .recorded { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 14px; overflow: hidden; display: block; }
    video { object-fit: cover; }
    .controls { display:flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    select, button, input[type="checkbox"] { font: inherit; }
    select, button { border-radius: 12px; border: 1px solid #334155; padding: 10px 14px; background: #0b1220; color: var(--fg); cursor: pointer; }
    button[disabled] { opacity: .45; cursor: not-allowed; }
    button.primary { background: linear-gradient(180deg, #1e293b, #0b1220); border-color: #3b82f6; }
    button.danger { border-color: #ef4444; }
    .row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    .pill { padding: 6px 10px; border-radius: 999px; border:1px solid #334155; font-size: 12px; color: var(--muted); }
    .status { font-size: 13px; color: var(--muted); }
    .blink { animation: blink 1s steps(2, start) infinite; }
    @keyframes blink { to { visibility: hidden; } }
    a.dl { display:inline-block; margin-top: 8px; color: white; text-decoration: none; border:1px solid #334155; border-radius: 10px; padding: 8px 12px; }
    .note { font-size: 12px; color: var(--muted); line-height: 1.5; }
    .chip { display:inline-flex; align-items:center; gap:6px; background:#0b1220; border:1px solid #334155; border-radius:999px; padding:6px 10px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ“¹ ã‚«ãƒ¡ãƒ©éŒ²ç”»ãƒŸãƒ‹ã‚¢ãƒ—ãƒª</h1>
      <div class="chip" title="æ¥ç¶šã¯å¿…ãšHTTPSã§">ğŸ”’ HTTPS æ¨å¥¨</div>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="row" style="justify-content: space-between;">
          <div class="row">
            <label for="cameraSelect" class="hint">ã‚«ãƒ¡ãƒ©</label>
            <select id="cameraSelect" title="ä½¿ç”¨ã™ã‚‹ã‚«ãƒ¡ãƒ©">
              <option value="environment">èƒŒé¢ï¼ˆç’°å¢ƒï¼‰</option>
              <option value="user">å‰é¢ï¼ˆè‡ªæ’®ã‚Šï¼‰</option>
              <option value="auto">è‡ªå‹•</option>
            </select>
          </div>
          <div class="row">
            <label class="hint"><input type="checkbox" id="micToggle" checked /> ãƒã‚¤ã‚¯ON</label>
            <label class="hint"><input type="checkbox" id="hdToggle" /> é«˜ç”»è³ª(1080pã‚’è©¦è¡Œ)</label>
          </div>
        </div>

        <video id="preview" playsinline muted autoplay></video>

        <div class="controls">
          <button id="startBtn" class="primary">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
          <button id="stopBtn" class="danger" disabled>ã‚«ãƒ¡ãƒ©åœæ­¢</button>
          <span class="pill" id="liveLabel">LIVEãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
        </div>
        <p class="status" id="status"></p>
      </section>

      <section class="panel">
        <h3 style="margin-top:0">ğŸï¸ éŒ²ç”»</h3>
        <div class="controls">
          <button id="recBtn" disabled>éŒ²ç”»é–‹å§‹</button>
          <button id="stopRecBtn" class="danger" disabled>éŒ²ç”»åœæ­¢</button>
          <span class="status" id="recStatus">å¾…æ©Ÿä¸­</span>
        </div>
        <video id="playback" class="recorded" controls playsinline></video>
        <a id="download" class="dl" href="#" download style="display:none">ä¿å­˜ã™ã‚‹</a>
        <p class="note">
          iPhone / iPad ã§ã¯ iOS 14.3 ä»¥é™ã§ <code>MediaRecorder</code> ãŒå‹•ä½œã—ã¾ã™ã€‚å¤ã„ç«¯æœ«ã§ã¯éŒ²ç”»ã¯éå¯¾å¿œã§ã™ã€‚<br>
          Safari / iOS ã§ã¯ <b>https</b> æ¥ç¶šã‹ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆ<code>localhost</code>ï¼‰ã§ã®ã¿ã‚«ãƒ¡ãƒ©ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚
        </p>
      </section>
    </div>

    <details style="margin-top:18px;" class="panel">
      <summary>ãƒˆãƒ©ãƒ–ãƒ«å¯¾å‡¦ã®ãƒ’ãƒ³ãƒˆ</summary>
      <ul class="note">
        <li>ã‚«ãƒ¡ãƒ©ãŒçœŸã£é»’ â†’ ã‚µã‚¤ãƒˆãŒHTTPSã§ã‚ã‚‹ã“ã¨ã€ã¾ãŸã¯ <code>localhost</code> ã§é–‹ã„ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚</li>
        <li>è‡ªå‹•å†ç”Ÿã•ã‚Œãªã„ â†’ ãƒœã‚¿ãƒ³ã‚’ä¸€åº¦æŠ¼ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦ãã ã•ã„ã€‚</li>
        <li>èƒŒé¢ã‚«ãƒ¡ãƒ©ã«åˆ‡ã‚Šæ›¿ã‚ã‚‰ãªã„ â†’ ç«¯æœ«ã«èƒŒé¢ã‚«ãƒ¡ãƒ©ãŒãªã„ï¼æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã€‚</li>
      </ul>
    </details>
  </div>

  <script>
    const preview = document.getElementById('preview');
    const playback = document.getElementById('playback');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const recBtn = document.getElementById('recBtn');
    const stopRecBtn = document.getElementById('stopRecBtn');
    const statusEl = document.getElementById('status');
    const recStatusEl = document.getElementById('recStatus');
    const cameraSelect = document.getElementById('cameraSelect');
    const micToggle = document.getElementById('micToggle');
    const hdToggle = document.getElementById('hdToggle');
    const downloadLink = document.getElementById('download');

    let stream = null;
    let recorder = null;
    let chunks = [];
    let chosenMime = '';

    function pickMimeType(){
      const candidates = [
        'video/mp4;codecs=h264,aac', // Safariç³»
        'video/mp4;codecs=avc1',
        'video/webm;codecs=vp9,opus',
        'video/webm;codecs=vp8,opus',
        'video/webm'
      ];
      for (const mime of candidates){
        if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(mime)){
          return mime;
        }
      }
      return '';
    }

    async function startCamera(){
      try{
        // åœæ­¢ä¸­ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        stopCamera();

        const facing = cameraSelect.value;
        const useMic = micToggle.checked;
        const hd = hdToggle.checked;

        const videoConstraints = { 
          width: hd ? { ideal: 1920 } : { ideal: 1280 },
          height: hd ? { ideal: 1080 } : { ideal: 720 },
          frameRate: { ideal: 30, max: 60 },
        };
        if (facing === 'environment') videoConstraints.facingMode = { ideal: 'environment' };
        else if (facing === 'user') videoConstraints.facingMode = { ideal: 'user' };

        stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio: useMic });
        preview.srcObject = stream;
        await preview.play();

        statusEl.textContent = 'ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­';
        startBtn.disabled = true; stopBtn.disabled = false; recBtn.disabled = false;
      } catch(err){
        console.error(err);
        statusEl.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸï¼š' + (err.message || err.name);
        startBtn.disabled = false; stopBtn.disabled = true; recBtn.disabled = true;
      }
    }

    function stopCamera(){
      if (stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      preview.srcObject = null;
      startBtn.disabled = false; stopBtn.disabled = true; recBtn.disabled = true;
      statusEl.textContent = 'åœæ­¢ä¸­';
    }

    function startRecording(){
      if (!stream){
        alert('å…ˆã«ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
        return;
      }
      chunks = [];
      chosenMime = pickMimeType();
      try{
        recorder = new MediaRecorder(stream, chosenMime ? { mimeType: chosenMime } : undefined);
      } catch (e){
        console.warn('MediaRecorderä½œæˆã«å¤±æ•—:', e);
        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŒ²ç”»ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
        return;
      }

      recorder.ondataavailable = (e)=>{ if (e.data && e.data.size) chunks.push(e.data); };
      recorder.onstop = handleRecordingStop;
      recorder.start();

      recBtn.disabled = true; stopRecBtn.disabled = false; recStatusEl.textContent = 'éŒ²ç”»ä¸­â€¦'; recStatusEl.classList.add('blink');
    }

    function stopRecording(){
      if (recorder && recorder.state !== 'inactive'){
        recorder.stop();
      }
      stopRecBtn.disabled = true; recBtn.disabled = false; recStatusEl.textContent = 'å‡¦ç†ä¸­â€¦';
    }

    function handleRecordingStop(){
      const blob = new Blob(chunks, { type: chosenMime || 'video/webm' });
      const url = URL.createObjectURL(blob);
      playback.src = url;
      playback.load();
      playback.play();

      const ext = (chosenMime && chosenMime.includes('mp4')) ? 'mp4' : 'webm';
      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      downloadLink.href = url;
      downloadLink.download = `recording-${stamp}.${ext}`;
      downloadLink.style.display = 'inline-block';

      recStatusEl.textContent = 'éŒ²ç”»å®Œäº†';
      recStatusEl.classList.remove('blink');
    }

    // UI events
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    recBtn.addEventListener('click', startRecording);
    stopRecBtn.addEventListener('click', stopRecording);

    // éŒ²ç”»ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°ï¼ˆã‚«ãƒ¡ãƒ©è¨­å®šå¤‰æ›´æ™‚ï¼‰
    [cameraSelect, micToggle, hdToggle].forEach(el => el.addEventListener('change', ()=>{
      if (stream){
        // åæ˜ ã®ãŸã‚å†èµ·å‹•ã‚’ä¿ƒã™
        statusEl.textContent = 'è¨­å®šãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚å†åº¦ã€Œã‚«ãƒ¡ãƒ©é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
      }
    }));

    // iOSã§ã®è‡ªå‹•å†ç”Ÿäº’æ›ã®ãŸã‚ã®å±æ€§
    preview.setAttribute('playsinline', 'true');
    playback.setAttribute('playsinline', 'true');

    // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰
    if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
      statusEl.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®Chrome / Safari / Edge / Firefoxã§ãŠè©¦ã—ãã ã•ã„ã€‚';
      startBtn.disabled = true;
    }
  </script>
</body>
</html>
